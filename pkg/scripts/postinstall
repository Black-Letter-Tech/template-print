#!/bin/bash
set -euo pipefail

PKG_ID="com.blacklettertech.template-print"
USER_HOME="${HOME:-}"

# Get the package root (where files are staged during install)
PACKAGE_ROOT="${1:-/}"

log() {
    echo "[$PKG_ID] $*" >&2
}

# User-space installation paths
USER_WORKFLOW_DEST="${USER_HOME}/Library/PDF Services/TemplatePrint.workflow"
USER_QPDF_BIN="${USER_HOME}/Library/Application Support/template-print/bin/qpdf"
USER_QPDF_LIB_DIR="${USER_HOME}/Library/Application Support/template-print/lib"
USER_UNINSTALLER_APP="${USER_HOME}/Applications/Template Print Uninstaller.app"
SHARED_TEMPLATE_DIR="/Users/Shared/Shared PDF Templates"
USER_TEMPLATE_DIR="${USER_HOME}/My PDF Templates"

# System staging paths (where pkgbuild installs)
STAGING_WORKFLOW="/Library/PDF Services/TemplatePrint.workflow"
STAGING_QPDF_BIN="/Library/Application Support/template-print/bin/qpdf"
STAGING_QPDF_LIB_DIR="/Library/Application Support/template-print/lib"
STAGING_UNINSTALLER="/Applications/Template Print Uninstaller.app"

log "Installing Template Print to user-space locations..."

# Move workflow to user-space
if [[ -d "${PACKAGE_ROOT}${STAGING_WORKFLOW}" ]] || [[ -d "${STAGING_WORKFLOW}" ]]; then
    source_workflow="${PACKAGE_ROOT}${STAGING_WORKFLOW}"
    [[ ! -d "$source_workflow" ]] && source_workflow="${STAGING_WORKFLOW}"
    
    mkdir -p "$(dirname "$USER_WORKFLOW_DEST")"
    if [[ -d "$USER_WORKFLOW_DEST" ]]; then
        rm -rf "$USER_WORKFLOW_DEST"
    fi
    cp -R "$source_workflow" "$USER_WORKFLOW_DEST"
    chmod -R 755 "$USER_WORKFLOW_DEST"
    log "Workflow installed: $USER_WORKFLOW_DEST"
fi

# Move qpdf to user-space
if [[ -f "${PACKAGE_ROOT}${STAGING_QPDF_BIN}" ]] || [[ -f "${STAGING_QPDF_BIN}" ]]; then
    source_qpdf="${PACKAGE_ROOT}${STAGING_QPDF_BIN}"
    [[ ! -f "$source_qpdf" ]] && source_qpdf="${STAGING_QPDF_BIN}"
    
    mkdir -p "$(dirname "$USER_QPDF_BIN")"
    cp "$source_qpdf" "$USER_QPDF_BIN"
    chmod 755 "$USER_QPDF_BIN"
    log "qpdf installed: $USER_QPDF_BIN"
    
    # Move qpdf libraries
    source_lib="${PACKAGE_ROOT}${STAGING_QPDF_LIB_DIR}"
    [[ ! -d "$source_lib" ]] && source_lib="${STAGING_QPDF_LIB_DIR}"
    
    if [[ -d "$source_lib" ]] && [[ -n "$(ls -A "$source_lib" 2>/dev/null)" ]]; then
        mkdir -p "$USER_QPDF_LIB_DIR"
        cp -R "$source_lib/"* "$USER_QPDF_LIB_DIR/" 2>/dev/null || true
        chmod -R 755 "$USER_QPDF_LIB_DIR"
        log "qpdf libraries installed: $USER_QPDF_LIB_DIR"
    fi
fi

# Move uninstaller to user-space
if [[ -d "${PACKAGE_ROOT}${STAGING_UNINSTALLER}" ]] || [[ -d "${STAGING_UNINSTALLER}" ]]; then
    source_uninstaller="${PACKAGE_ROOT}${STAGING_UNINSTALLER}"
    [[ ! -d "$source_uninstaller" ]] && source_uninstaller="${STAGING_UNINSTALLER}"
    
    mkdir -p "$(dirname "$USER_UNINSTALLER_APP")"
    if [[ -d "$USER_UNINSTALLER_APP" ]]; then
        rm -rf "$USER_UNINSTALLER_APP"
    fi
    cp -R "$source_uninstaller" "$USER_UNINSTALLER_APP"
    chmod -R 755 "$USER_UNINSTALLER_APP"
    log "Uninstaller installed: $USER_UNINSTALLER_APP"
fi

# Create template directories
mkdir -p "$SHARED_TEMPLATE_DIR"
chmod 755 "$SHARED_TEMPLATE_DIR" 2>/dev/null || true
log "Shared template directory: $SHARED_TEMPLATE_DIR"

mkdir -p "$USER_TEMPLATE_DIR"
chmod 755 "$USER_TEMPLATE_DIR"
log "User template directory: $USER_TEMPLATE_DIR"

log "Installation complete. Template Print is installed for user: ${USER_HOME}"
exit 0
