#!/bin/bash
set -euo pipefail

# User-space paths (no sudo required)
WORKFLOW_DEST="${HOME}/Library/PDF Services/TemplatePrint.workflow"
QPDF_BIN="${HOME}/Library/Application Support/template-print/bin/qpdf"
QPDF_LIB_DIR="${HOME}/Library/Application Support/template-print/lib"
QPDF_SUPPORT_DIR="${HOME}/Library/Application Support/template-print"
UNINSTALLER_APP="${HOME}/Applications/Template Print Uninstaller.app"
DEFAULTS_DOMAIN="com.blacklettertech.template-print"

# Confirm uninstallation
response=$(osascript <<EOF
set response to button returned of (display dialog "This will remove Template Print from your account:

• Workflow: ~/Library/PDF Services/TemplatePrint.workflow
• Bundled qpdf: ~/Library/Application Support/template-print/
• Preferences: com.blacklettertech.template-print

Continue with uninstallation?" buttons {"Cancel", "Uninstall"} default button "Cancel" cancel button "Cancel" with icon caution)
return response
EOF
)

if [[ "$response" != "Uninstall" ]]; then
    osascript -e 'display dialog "Uninstallation cancelled." buttons {"OK"} default button "OK"'
    exit 0
fi

# Remove workflow
if [[ -d "$WORKFLOW_DEST" ]]; then
    rm -rf "$WORKFLOW_DEST"
    echo "Removed workflow: $WORKFLOW_DEST"
fi

# Remove bundled qpdf
if [[ -f "$QPDF_BIN" ]]; then
    rm -f "$QPDF_BIN"
    echo "Removed bundled qpdf: $QPDF_BIN"
fi

if [[ -d "$QPDF_LIB_DIR" ]]; then
    rm -rf "$QPDF_LIB_DIR"
    echo "Removed bundled qpdf libraries: $QPDF_LIB_DIR"
fi

# Remove Application Support directory if empty
if [[ -d "$QPDF_SUPPORT_DIR" ]]; then
    if [[ -z "$(ls -A "$QPDF_SUPPORT_DIR" 2>/dev/null)" ]]; then
        rmdir "$QPDF_SUPPORT_DIR" 2>/dev/null || true
        echo "Removed Application Support directory: $QPDF_SUPPORT_DIR"
    fi
fi

# Remove user defaults
defaults delete "$DEFAULTS_DOMAIN" >/dev/null 2>&1 || true
echo "Removed preferences: $DEFAULTS_DOMAIN"

# Remove uninstaller itself
if [[ -d "$UNINSTALLER_APP" ]]; then
    rm -rf "$UNINSTALLER_APP"
    echo "Removed uninstaller: $UNINSTALLER_APP"
fi

osascript -e 'display dialog "Template Print has been successfully uninstalled from your account." buttons {"OK"} default button "OK"'
exit 0
