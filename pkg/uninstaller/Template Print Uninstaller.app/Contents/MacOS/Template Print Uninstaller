#!/bin/bash
set -euo pipefail

BIN_DEST="/usr/local/bin/template-print"
WORKFLOW_DEST="/Library/PDF Services/TemplatePrint.workflow"
EXAMPLES_DEST="/Users/Shared/PDFTemplates/examples"
UNINSTALLER_APP="/Applications/Utilities/Template Print Uninstaller.app"

# Check for admin privileges
if [[ $EUID -ne 0 ]]; then
    # Not running as root, try to elevate
    osascript -e 'do shell script "bash \"'$0'\" 2>&1" with administrator privileges' 2>/dev/null
    exit $?
fi

# Confirm uninstallation
response=$(osascript <<'EOF'
set response to button returned of (display dialog "This will remove Template Print from your system:

• Binary: /usr/local/bin/template-print
• Workflow: /Library/PDF Services/TemplatePrint.workflow
• Examples: /Users/Shared/PDFTemplates/examples

Continue with uninstallation?" buttons {"Cancel", "Uninstall"} default button "Cancel" cancel button "Cancel" with icon caution)
return response
EOF
)

if [[ "$response" != "Uninstall" ]]; then
    osascript -e 'display dialog "Uninstallation cancelled." buttons {"OK"} default button "OK"'
    exit 0
fi

# Remove files
if [[ -f "$BIN_DEST" ]]; then
    rm -f "$BIN_DEST"
    echo "Removed binary: $BIN_DEST"
fi

if [[ -d "$WORKFLOW_DEST" ]]; then
    rm -rf "$WORKFLOW_DEST"
    echo "Removed workflow: $WORKFLOW_DEST"
fi

if [[ -d "$EXAMPLES_DEST" ]]; then
    rm -rf "$EXAMPLES_DEST"
    echo "Removed examples: $EXAMPLES_DEST"
    # Clean up parent directory if it's empty (but don't remove /Users/Shared/PDFTemplates if user has other files)
    rmdir "$(dirname "$EXAMPLES_DEST")" 2>/dev/null || true
fi

# Remove uninstaller itself
if [[ -d "$UNINSTALLER_APP" ]]; then
    rm -rf "$UNINSTALLER_APP"
    echo "Removed uninstaller: $UNINSTALLER_APP"
fi

osascript -e 'display dialog "Template Print has been successfully uninstalled from your system." buttons {"OK"} default button "OK"'
exit 0
